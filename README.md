# 페트병 실링 불량 분류 시스템
PET Bottle Seal Defect Classification System

## 프로젝트 개요
영상처리 및 인공지능 기반으로 실시간 페트병 실링 불량 여부를 판별하는 자동화 검사 시스템입니다. C++ MFC 클라이언트, C# 중계 서버, Python AI 서버로 구성된 다중 언어 통합 시스템으로, 생산 효율을 높이고 검사 인력을 절감합니다.

## 프로젝트 정보
- **개발 기간**: 2025.10.24(금) ~ 2025.10.30(목)
- **주요 주제**: 영상처리 및 인공지능 기반 불량 검출 시스템

## 개발 환경
- **언어**: C++ (MFC) / C# (.NET) / Python
- **OS**: Windows
- **IDE**: Visual Studio, VS Code
- **데이터베이스**: MySQL
- **AI 프레임워크**: YOLOv8

## 팀원 및 담당 업무
| 이름 | 담당 파트 |
|------|----------|
| 팀장 | C# (.NET) Server (중계 서버) |
| 팀원1 | Python AI Server (불량 검출 서버) |
| **이수민** | **C++ (MFC) Client (영상 입력/결과 표시)** |
| 팀원2 | DB (MySQL) |

## 개발 목적
실시간으로 페트병 실링 불량 여부를 판별하여 생산 효율을 높이고 검사 인력을 절감

## 시스템 아키텍처
```
[C++ MFC 클라이언트]  ← 이수민 담당
    ↓ (이미지 전송)
[C# 중계 서버]
    ↓ (이미지 전송)
[Python AI 서버]
    ↓ (YOLOv8 분석)
    ↓ (결과 JSON)
[MySQL 데이터베이스]
```

## 주요 구현 기능

### 1. C++ MFC 클라이언트 ⭐ **이수민 담당**

#### 카메라 영상 입력
- PC에 연결된 카메라로부터 실시간 프레임 수신
- 카메라로 비춰진 화면에서 페트병 캡처
- OpenCV 기반 영상 처리

#### 영상 전처리 기능
- 병 입구, 캡 부위, 실링 부위 중심으로 검출
- ROI(Region of Interest) 자동 추출

#### 결과 수신 및 표시
- C# 서버로부터 판정 결과(JSON) 수신
- UI 상에서 결과를 정상/불량으로 표시
- 모델 분석 결과를 확률(정확도 %) 형태로 표시

#### 사용자 인터페이스
- 실시간 카메라 영상과 결과 표시 영역 통합 UI
- 검사 시작/중지 기능 제공
- 판정 결과(시간/결과/정확도) 표시

### 2. C# 중계 서버

#### 이미지 수신 서버
- MFC 클라이언트에서 전송된 영상 프레임을 TCP로 수신
- 이미지 데이터를 메모리 버퍼에 저장 후 Python AI 서버로 전달

#### AI 서버 연동
- Python 서버로 바이너리 형식의 이미지 전송
- YOLOv8 모델 판정 결과(JSON) 수신 및 파싱

#### 결과 중계
- AI 서버에서 받은 결과(JSON)를 MFC 클라이언트로 재전송
- 정상/불량 상태와 정확도 값 전달

#### 데이터베이스 저장
- C++ 클라이언트로부터 수신한 이미지를 주소로 저장
- Python 서버로부터 수신한 JSON 형식의 데이터 저장

### 3. Python AI 서버

#### Flask 기반 HTTP 서버
- C# 서버로부터 전송된 이미지 요청 수신
- 업로드된 이미지를 임시 저장 후 분석 수행

#### 영상 전처리
- 입력 영상에서 페트병 ROI(실링 영역) 자동 추출

#### AI 모델 기반 불량 판정
- YOLOv8 또는 CNN 기반 AI 모델 사용
- 실시간으로 영상 프레임 내 실링 상태 분석
- 정상/불량 판정 및 정확도(%) 계산

## 이수민 담당 C++ MFC 클라이언트 상세

### 🎯 핵심 역할
사용자가 직접 상호작용하는 프론트엔드 클라이언트로, 카메라를 통한 실시간 영상 캡처, 전처리, 서버 통신, 결과 표시까지 전체 사용자 경험을 담당

### 📸 카메라 제어 및 영상 처리
- **실시간 스트리밍**: OpenCV VideoCapture를 활용한 카메라 영상 실시간 수신
- **프레임 캡처**: 사용자 명령 시 현재 프레임을 정지 이미지로 캡처
- **영상 전처리**: 
  - 이미지 노이즈 제거
  - 밝기/대비 조정
  - ROI 영역 자동 추출

### 🔗 네트워크 통신
- **TCP 소켓 통신**: C# 서버와의 안정적인 연결 유지
- **이미지 직렬화**: 캡처한 이미지를 바이너리 형태로 변환 및 전송
- **JSON 파싱**: 서버로부터 받은 판정 결과 해석

### 🖥 사용자 인터페이스
- **MFC 다이얼로그**: 직관적인 윈도우 기반 UI
- **실시간 비디오 디스플레이**: Picture Control에 카메라 영상 표시
- **결과 표시 패널**: 
  - 판정 결과 (정상/불량)
  - 정확도 퍼센트
  - 검사 시간
- **제어 버튼**: 카메라 시작/중지, 검사 실행

### 💾 데이터 관리
- **검사 이력 저장**: 로컬 로그 파일 생성
- **이미지 임시 저장**: 전송 전 로컬 캐싱

## 예상 문제점과 해결방안

### 1. 모델 학습 데이터 부족
**문제**: 다양한 조건(환경, 각도, 조명)을 반영한 데이터 부족 시 오탐률 증가

**해결방안**:
- 데이터셋 확장: 실제 사용 환경을 반영한 다양한 샘플 추가
- 클래스 불균형 개선: 학습 데이터 내 각 클래스 비율 조절 및 손실 함수 클래스 가중치 조정

### 2. 다중 언어 시스템 간 통신 호환성
**문제**: C++ ↔ C# ↔ Python 간 데이터 송수신 형식 불일치

**해결방안**:
- JSON 기반 헤더 + 바이너리 본문 구조로 통일
- 헤더에 데이터 크기, 형식, 인코딩 정보, 식별자(ID) 포함
- 표준 프로토콜 정의 및 문서화

### 3. 이미지 저장 및 DB 참조 관리
**문제**: 파일 시스템 저장 시 경로 변경/삭제로 DB 참조 손실

**해결방안**:
- 이미지를 BLOB 타입으로 DB에 직접 저장 또는 AWS S3 활용
- 파일 존재 여부 검증 배치 작업 구현
- DB-이미지 통합 백업 자동화

## 통신 프로토콜

### 이미지 전송 (C++ → C#)
```json
{
  "type": "image",
  "size": 1024000,
  "format": "jpg",
  "timestamp": "2025-10-30T10:30:00"
}
[바이너리 이미지 데이터]
```

### 판정 결과 (C# → C++)
```json
{
  "result": "defect",
  "confidence": 95.7,
  "class": "broken_seal",
  "timestamp": "2025-10-30T10:30:01"
}
```

## 설치 및 실행

### 사전 요구사항
```bash
# Visual Studio 2022 (C++, C# 지원)
# Python 3.8 이상
# MySQL Server 8.0
# OpenCV 4.x

# Python 패키지 설치
pip install flask opencv-python ultralytics
```

### 실행 순서
1. **MySQL 서버 시작**
2. **Python AI 서버 실행**
   ```bash
   python ai_server.py
   ```
3. **C# 중계 서버 실행**
   ```bash
   dotnet run
   ```
4. **C++ MFC 클라이언트 실행**
   - Visual Studio에서 빌드 후 실행

## 프로젝트 구조
```
PET-Bottle-Defect-Detection/
├── MFC_Client/           # C++ MFC 클라이언트 (이수민 담당)
│   ├── MainDlg.cpp
│   ├── CameraManager.cpp
│   └── NetworkClient.cpp
├── CSharp_Server/        # C# 중계 서버
│   ├── Program.cs
│   ├── ImageReceiver.cs
│   └── DatabaseManager.cs
├── Python_AI/            # Python AI 서버
│   ├── app.py
│   ├── model.py
│   └── best.pt
└── Database/
    └── schema.sql
```

## 개발 성과
- **다중 언어 통합**: C++, C#, Python 시스템 통합 경험
- **실시간 영상 처리**: OpenCV를 활용한 영상 처리 기술 습득
- **AI 모델 연동**: YOLOv8 모델과의 실시간 통신 구현
- **네트워크 프로그래밍**: TCP 소켓 통신 및 프로토콜 설계
- **MFC GUI 개발**: 윈도우 기반 사용자 인터페이스 개발 역량

## 라이센스
이 프로젝트는 교육 목적으로 제작되었습니다.
